"use strict";function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();!function(a){var b={btnBack:"btn-back",btnDelete:"btn-delete",btnNew:"btn-new",btnSave:"btn-save",formGrid:"form-grid",formEdit:"form-edit",gridContainerId:"grid-container",gridRowClass:"admin-grid-row",hiddenClass:"hidden",lblItem:"lbl-item",lblItems:"lbl-items",wsUrl:"/api/"},c=new app.Toast,d=new app.Alert,e=window.location.pathname,f=function(){function a(c){_classCallCheck(this,a),this.options=c,this.labelItemText=c.labelItemText,this.labelItemsText=c.labelItemsText,this.initItemFn=c.initItem?c.initItem.callback:null,this.loadItemsFn=c.loadItems.fn,this.loadItemsParams=c.loadItems.params,this.loadItemsRowHTML=c.loadItems.rowTmpl,this.loadItemsRowHeaders=c.loadItems.rowTmplHeaders,this.loadItemsRowProps=c.loadItems.rowTmplProps,this.editItemFn=c.editItem.fn,this.editItemParams=c.editItem.params,this.editItemItemId=c.editItem.itemId,this.editItemCallback=c.editItem.callback,this.saveItemFn=c.saveItem.fn,this.saveItemId=c.saveItem.itemId,this.sendAsString=c.saveItem.sendAsString||!1,this.saveCallback=c.saveItem.callback,this.deleteItemFn=c.deleteItem.fn,this.deleteItemItemId=c.deleteItem.itemId,this.backToGridCallback=c.back.fn,this.items=[],this.formGrid=new app.Form(app.$("#"+b.formGrid)),this.formEdit=new app.Form(app.$("#"+b.formEdit)),this.btnNew=app.$("#"+b.btnNew),this.btnBack=app.$("#"+b.btnBack),this.btnDelete=app.$("#"+b.btnDelete),this.btnSave=app.$("#"+b.btnSave),this.itemId=-1,this.additionadditionalPropertiesDefault=app.util.cloneObj(c.additionalProperties||{}),this.additionalProperties=app.util.cloneObj(c.additionalProperties||{}),this.setLabels=this.setLabels.bind(this),this.loadItems=this.loadItems.bind(this),this.buildGrid=this.buildGrid.bind(this),this.initNewItem=this.initNewItem.bind(this),this.editData=this.editData.bind(this),this.saveItem=this.saveItem.bind(this),this.backToGrid=this.backToGrid.bind(this),this.btnDeleteClickHandler=this.btnDeleteClickHandler.bind(this),this.deleteItem=this.deleteItem.bind(this),this.popstateHanlder=this.popstateHanlder.bind(this),this.setLabels(),this.addEventListeners(),this.loadItems()}return _createClass(a,[{key:"setLabels",value:function(){var a=this;app.$.forEach("."+b.lblItem,function(b){b.textContent=a.labelItemText}),app.$.forEach("."+b.lblItems,function(b){b.textContent=a.labelItemsText})}},{key:"addEventListeners",value:function(){this.btnNew.addEventListener("click",this.initNewItem,!1),this.btnBack.addEventListener("click",this.backToGrid,!1),this.btnSave.addEventListener("click",this.saveItem,!1),this.btnDelete.addEventListener("click",this.btnDeleteClickHandler,!1),window.addEventListener("popstate",this.popstateHanlder,!1)}},{key:"loadItems",value:function(){var a=this;app.$.fetch(b.wsUrl+this.loadItemsFn,{body:this.loadItemsParams}).then(function(b){b.success&&(a.items=b.obj,a.buildGrid())}).catch(function(a){console.log("Error loading items.",a)})}},{key:"buildGrid",value:function(){var a=this,c="",d="";d=this.loadItemsRowHTML;for(var e=0;e<this.loadItemsRowHeaders.length;e++){var f=this.loadItemsRowHeaders[e],h=this.loadItemsRowProps[e];d=d.replace("{{"+h+"}}",f)}d=d.replace("{{rowClass}}"," hdr"),c+=d;for(var i=0;i<this.items.length;i++){var j=this.items[i];d=this.loadItemsRowHTML.replace("{{rowClass}}","");for(var k=0;k<this.loadItemsRowProps.length;k++){var l=this.loadItemsRowProps[k],m=j[l];"active"===l&&(m=m===!0?"Active":"Not Active"),d=d.replace("{{"+l+"}}",m)}c+=d}app.$("#"+b.gridContainerId).innerHTML=c,setTimeout(function(){app.$.forEach("."+b.gridRowClass,function(b){new g(b,a)})},10)}},{key:"initNewItem",value:function(){this.itemId=-1,this.formEdit.container.querySelector("#tb-sort-order")&&(this.formEdit.container.querySelector("#tb-sort-order").value=this.items.length+1),this.formGrid.hide(),this.formEdit.show(),this.btnDelete.classList.add(b.hiddenClass),this.initItemFn&&"function"==typeof this.initItemFn&&this.initItemFn(),history.pushState({page:"edit"},"Edit","?edit")}},{key:"editData",value:function(a){var d=this;c.show("Loading item details...",-1),this.itemId=a,this.editItemParams[this.editItemItemId]=this.itemId,app.$.fetch(b.wsUrl+this.editItemFn,{body:this.editItemParams}).then(function(a){var e=void 0;a.success&&a.obj.length&&(e=a.obj[0],d.formEdit.setFieldValues(e),d.formEdit.show(),d.formGrid.hide(),d.btnDelete.classList.remove(b.hiddenClass),d.additionalProperties&&Object.getOwnPropertyNames(d.additionalProperties).forEach(function(a){d.additionalProperties[a]=e[a]}),window.scrollTo(0,0),c.hide(!0),d.editItemCallback&&"function"==typeof d.editItemCallback&&d.editItemCallback(e),history.pushState({page:"edit"},"Edit","?edit"))}).catch(function(a){console.log(a)})}},{key:"saveItem",value:function(){var a=this,d=this,e=this.formEdit.validateFields(),f={};return e?(c.show("Saving data, please wait..."),f=this.formEdit.collectData(),this.additionalProperties&&Object.getOwnPropertyNames(this.additionalProperties).forEach(function(b){f[b]=a.additionalProperties[b]}),f[this.saveItemId]=this.itemId,this.sendAsString&&(f={data:JSON.stringify(f)}),void app.$.fetch(b.wsUrl+this.saveItemFn,{body:f}).then(function(b){b.success?(c.show("Data saved successfully.",2e3),d.loadItems(),a.itemId===-1&&(a.itemId=b.obj),a.saveCallback&&"function"==typeof a.saveCallback&&a.saveCallback()):(c.show("Unable to save at this time, please try again.",-1),console.log("Error:",b||"No error data."))}).catch(function(a){c.show("Unable to save at this time, please try again.",-1),console.log("Error:",a||"No error data.")})):void c.show("Fields marked with * are required.")}},{key:"backToGrid",value:function(){var a=this;this.formEdit.hide(),this.formEdit.clearForm(),this.formGrid.show(),this.itemId=-1,this.additionalProperties&&Object.getOwnPropertyNames(this.additionalProperties).forEach(function(b){a.additionalProperties[b]=a.additionadditionalPropertiesDefault[b]}),this.backToGridCallback&&"function"==typeof this.backToGridCallback&&this.backToGridCallback(),window.scrollTo(0,0),history.pushState({page:""},"Options",e)}},{key:"btnDeleteClickHandler",value:function(){this.deleteItem(this.itemId)}},{key:"deleteItem",value:function(a){var e=this,f=this,g={};g[this.deleteItemItemId]=a,d.promptAlert("Confirm Delete","<p>Are you sure you want to delete this item?","Delete","Cancel",function(a){d.dismissAlert(),c.show("Deleting item..."),app.$.fetch(b.wsUrl+e.deleteItemFn,{body:g}).then(function(a){a.success?(c.show("Item successfully deleted.",2500),f.loadItems(),setTimeout(function(){f.backToGrid()},1e3)):(c.show("Unable to delete at this time. Please try again."),console.log("Error:",a.msg||"No error data"))}).catch(function(a){c.show("Unable to delete at this time. Please try again."),console.log("Error:",a||"No error data")}),a.preventDefault()},function(a){d.dismissAlert(),a.preventDefault()})}},{key:"setAdditionalPropertyData",value:function(a,b){this.additionalProperties[a]=b}},{key:"getAdditionalPropertyData",value:function(a){return this.additionalProperties[a]}},{key:"popstateHanlder",value:function(a){a.state&&""!==a.state.page||this.backToGrid()}},{key:"uploadHelper",value:function(a,b,d,e,f){var g=a.name,h=a.type,i=new FileReader;!b||/^image\//.test(h)?(c.show("Uploading file, please wait...",-1),i.onload=function(b){var i=new XMLHttpRequest;i.open("post",d,!0),i.setRequestHeader("X-File-Name",g),i.setRequestHeader("X-File-Size",a.size),i.setRequestHeader("X-File-Type",h);for(var j in e)i.setRequestHeader(j,e[j]);i.addEventListener("load",function(a){if(a.target.response){var b=JSON.parse(a.target.response);b.success?(c.show("The file was successfully uploaded."),setTimeout(function(){c.hide(!0)},1e3),f&&"function"==typeof f&&f(b.obj)):(c.show("Unable to upload the file, please try again.",-1),console.log("Error:",b.msg||"No error data."))}},!1),i.send(a)},i.readAsDataURL(a)):c.show("Only .jpg, .jpeg, and .png files are allowed.",-1)}}]),a}(),g=function(){function a(b,c){_classCallCheck(this,a),this.container=b,this.AdminForm=c,this.id=b.getAttribute("data-id"),this.btnEdit=b.querySelector(".btn-edit"),this.btnDelete=b.querySelector(".btn-delete"),this.editItem=this.editItem.bind(this),this.deleteItem=this.deleteItem.bind(this),this.addEventListeners()}return _createClass(a,[{key:"addEventListeners",value:function(){this.btnEdit.addEventListener("click",this.editItem,!1),this.btnDelete.addEventListener("click",this.deleteItem,!1)}},{key:"editItem",value:function(){this.AdminForm.editData(this.id)}},{key:"deleteItem",value:function(){this.AdminForm.deleteItem(this.id)}}]),a}();app.AdminForm=f}(document);